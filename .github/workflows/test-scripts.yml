name: Run Python Scripts

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Url to be used during script execution"
        required: true
        type: string
      environment:
        description: "Which API Key to use"
        default: preview
        required: true
        type: choice
        options:
          - preview
          - production

  push:

  pull_request:

jobs:
  execute-python-scripts:
    runs-on: ubuntu-latest

    env:
      # Storing the user-supplied URL
      # TOFUPILOT_URL: https://www.tofupilot.app
      TOFUPILOT_URL: ${{ secrets.TOFUPILOT_URL }}

    steps:
      # Checking out the repository
      - name: Checking out the repository
        uses: actions/checkout@v3

      # Setting the appropriate API key based on environment choice
      - name: Setting TOFUPILOT_API_KEY
        # run: |
        #   if [ "${{ github.event.inputs.environment }}" = "production" ] || [ -z "${{ github.event.inputs.environment }}" ]; then
        #     # Using the production key if environment is production or not defined
        #     echo "TOFUPILOT_API_KEY=${{ secrets.PRODUCTION_API_KEY }}" >> $GITHUB_ENV
        #   else
        #     # Using the preview key otherwise
        #     echo "TOFUPILOT_API_KEY=${{ secrets.PREVIEW_API_KEY }}" >> $GITHUB_ENV
        #   fi
        run: |
          if [ "${{ github.event.inputs.environment }}" = "preview" ]; then
            echo "TOFUPILOT_API_KEY=${{ secrets.PREVIEW_API_KEY }}" >> $GITHUB_ENV
          else
            echo "TOFUPILOT_API_KEY=${{ secrets.PRODUCTION_API_KEY }}" >> $GITHUB_ENV
          fi

      # Setting up Python
      - name: Setting up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # Installing dependencies and the tofupilot client for the given version
      - name: Installing dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # pip install -i https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ tofupilot==1.9.0.dev3

      # Finding and running all Python scripts in the scripts folder and subfolders
      - name: Running all Python scripts
        run: |
          echo "Testing branch ${{ env.TOFUPILOT_URL }}..."
          # Finding every `main.py` files, excluding virtual environment and hidden directories
          find . -type f -name 'main.py' \
            -not -path '*/venv/*' \
            -not -path '*/.*/*' \
            -print0 | while IFS= read -r -d '' file; do

            # Storing directory containing the `main.py`
            directory="$(dirname "$file")"

            # Checking if requirements.txt is present in the same directory as `main.py`
            if [ -f "$directory/requirements.txt" ]; then
              # Installing dependencies from requirements.txt before running the script
              pip install -r "$directory/requirements.txt"
            fi

            echo "Running files in $directory"

            # Executing `main.py` from within its own directory
            (
              cd "$directory" || exit
              python main.py
            )
          done
